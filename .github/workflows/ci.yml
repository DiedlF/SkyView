name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pipx install ruff black mypy
      - run: ruff check .
      - run: black --check .
      - run: mypy backend/

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: unit
            pytest-args: tests/ -m "not integration and not perf" --cov=backend/ --cov-report=xml --cov-report=term-missing
          - name: integration
            pytest-args: tests/ -m integration
          - name: perf
            pytest-args: tests/ -m perf
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov pytest-asyncio
      - name: Run pytest
        run: pytest ${{ matrix.pytest-args }}
        env:
          PYTHONPATH: backend/
      - uses: codecov/codecov-action@v4
        if: matrix.name == 'unit'

  qa:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install -r backend/requirements.txt
      - name: Start server and run QA checks
        run: |
          python3 backend/app.py &
          APP_PID=$!
          # Wait up to 30s for the server to become ready (cold-start import of scipy/numpy/xarray can be slow)
          echo "Waiting for server to be ready..."
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8501/api/health > /dev/null 2>&1; then
              echo "Server ready after ${i}s"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Server did not become ready within 30s"
              kill $APP_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done
          python3 scripts/qa_smoke.py && python3 scripts/qa_regression.py && python3 scripts/qa_contract.py
          QA_EXIT=$?
          kill $APP_PID 2>/dev/null || true
          exit $QA_EXIT
        env:
          PYTHONPATH: backend/
